set-option -g default-command zsh
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",alacritty:RGB"
set -g mouse on
set -sg escape-time 0    # No delay on Escape (important for Neovim)

# remap prefix to Control + a
unbind C-b
set-option -g prefix C-a
bind C-a send-prefix

# Use vim keybindings in copy mode
setw -g mode-keys vi

set -g status-style "bg=#181825,fg=#cdd6f4"    # catppuccin mocha mantle/text
set -g status on
set -g pane-border-style "fg=#9399b2"          # catppuccin mocha overlay2 (bright)
set -g pane-active-border-style "fg=#b4befe"   # catppuccin mocha lavender
set -g pane-border-lines double                # double-line borders
set -g pane-border-indicators off              # no indicators

# Window status styling (Catppuccin Mocha)
set -g window-status-format "#[fg=#6c7086] #I:#W "              # overlay0 for inactive
set -g window-status-current-format "#[fg=#89b4fa,bold] #I:#W#{?window_zoomed_flag, [Z],} " # blue for active, zoom indicator
set -g window-status-separator ""

set -g status-left-length 30
set -g status-left '#[fg=#89b4fa,bold] #S #[fg=#6c7086]| '

bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi r send-keys -X rectangle-toggle

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Open new panes/windows in current directory
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Status right: spotify | cpu | mem | battery | date + clock
set -g status-right-length 120
set -g status-right '#{prefix_highlight} #{?#{spotify_status},#[fg=#a6e3a1]󰝚 #{artist} - #{track} #[fg=#6c7086]| ,}#[fg=#89b4fa]󰍛 #{cpu_percentage} #[fg=#6c7086]| #[fg=#cba6f7]󰘚 #{ram_percentage} #[fg=#6c7086]| #{battery_icon_status} #{battery_percentage} #[fg=#6c7086]| %a %H:%M '

# Plugins (requires TPM - installed via init.zsh)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'robhurring/tmux-spotify'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Battery styling
set -g @batt_icon_status_charged '󰁹'
set -g @batt_icon_status_charging '󰂄'
set -g @batt_icon_status_discharging '󰂃'
set -g @batt_icon_status_attached '󰂃'
set -g @batt_icon_status_unknown '󰂑'

# Spotify styling
set -g @spotify_playing_icon ''
set -g @spotify_paused_icon ''
set -g @spotify_stopped_icon ''

# CPU/RAM styling (using Catppuccin colors via status-right)

# Prefix highlight styling (Catppuccin Mocha)
set -g @prefix_highlight_fg '#1e1e2e'
set -g @prefix_highlight_bg '#f5c2e7'
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=#1e1e2e,bg=#f9e2af'

# Session save/restore (tmux-resurrect + tmux-continuum)
set -g @resurrect-strategy-nvim 'session'   # restore nvim sessions via persistence.nvim
set -g @resurrect-capture-pane-contents 'on' # save pane contents
set -g @continuum-restore 'on'               # auto-restore on tmux start
set -g @continuum-save-interval '10'         # auto-save every 10 minutes

# Clean up orphaned nvim --embed processes when a session closes
set-hook -g session-closed 'run-shell -b "zsh -c \"source ~/Dev/dotfiles/zsh/functions.zsh && kill-orphan-nvims\" >> /tmp/kill-orphan-nvims.log 2>&1"'

# Initialize TPM (keep at bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
